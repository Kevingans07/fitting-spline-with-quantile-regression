---
title: "F1 cars data"
output: html_document
date: "2025-10-29"
---



## Using FastF1 data
type this in R terminal -> python -m venv fastf1_env
                          source fastf1_env/bin/activate
I also pip install fastf1 matplotlib pandas numpy (dont have to do this anymore)

my environment -> /Users/vincentiuskevin/fastf1_env
                      

```{r}
install.packages("reticulate")
```

```{r}
library(reticulate)
use_virtualenv("/Users/vincentiuskevin/fastf1_env", required = TRUE)
```

```{r}
## Checking that Python is connected with R
py_config() 
```
## In terminal, I created mkdir for fastf1_cache. Enabling cache is to save the data locally after the first download
```{r}
fastf1 <- import("fastf1")
fastf1$Cache$enable_cache("fastf1_cache")

schedule <- fastf1$get_event_schedule(2023L)
schedule
```
## Now, I want to look at 2023 Season Race in F1 in Bahrain specifically
```{r}
session <- fastf1$get_session(2023L, "Mexico", "R") #2023L is 2023 season in R code
                                                    # while "R" indicates Race session
session$load()
```

```{r}
library(dplyr) #to make dataframe easier to read


#Access laps
laps <- session$laps
# Convert to native R dataframe
laps_df <- py_to_r(laps)


# Inspect column names to see what's available
colnames(laps_df)
head(laps_df)


```

```{r}
# Create a clean stints summary: Lap start/end per driver, per stint, per tire compound
#stint is the cars tires durability until it goes to the next pit stop
#compound is tires category: soft, medium, or hard

#LapStart here is the first time the tire stints
#LapEnd is the last time the tire stints

# stints <- laps_df %>%
#   group_by(Driver, Team, Stint, Compound) %>%
#   summarize(
#     LapStart = min(LapNumber),
#     LapEnd = max(LapNumber),
#     .groups = 'drop'
#   )
# 
# stints

# 1️⃣ Clean laps dataset: arrange properly
laps_df <- laps_df %>%
  arrange(Driver, LapNumber)

# 2️⃣ Assign proper stints by consecutive compound runs
laps_df <- laps_df %>%
  group_by(Driver) %>%
  mutate(
    stint_id = cumsum(Compound != lag(Compound, default = first(Compound))) + 1
  )

# 3️⃣ Summarize stints
stints <- laps_df %>%
  group_by(Driver, Team, stint_id, Compound) %>%
  summarize(
    LapStart = min(LapNumber),
    LapEnd   = max(LapNumber),
    LapsInStint = LapEnd - LapStart + 1,  # number of laps in this stint
    AvgSpeedST = mean(SpeedST, na.rm=TRUE), # optional: average top sector speed
    .groups = 'drop'
  )

#na.rm is to ignore missing value

# 4️⃣ Get final race positions
final_positions <- laps_df %>%
  group_by(Driver) %>%
  filter(LapNumber == max(LapNumber)) %>%
  select(Driver, FinalPosition = Position)

# 5️⃣ Combine stints with final positions
stints_final <- stints %>%
  left_join(final_positions, by="Driver") %>%
  arrange(FinalPosition, Driver, LapStart)

# Inspect the result
stints_final
```

##Now, I want to fit splines to Quantile Regression model from this clean stints_final dataset

## Research Question : How will lap time evolve as fuel burns and tire wear increases
```{r}
library(mgcv)

#construct cubic regression spline basis for LapsinStint
sm <- smoothCon(s(
                  LapsInStint, k=10, bs ="cr"), 
                data=stints_final, 
                knots =NULL)[[1]]

#extract the spline basis matrix
X <- sm$X

#plot each spline basis function
matplot(stints_final$LapsInStint, X, 
        type ='l', lty =1,
        ylab = "Spline Basis Function",
        xlab = "Laps in Stint",
        main = "Cubic Regression Spline Basis with k =10")

```
